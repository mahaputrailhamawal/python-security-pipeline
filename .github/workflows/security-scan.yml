name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run every Monday at 9 AM
    - cron: '0 9 * * 1'

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit scan
        continue-on-error: true
        run: |
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          bandit -r app/ -f json -o bandit-results.json || true
          echo "‚úÖ Bandit scan complete"
          echo "Checking if bandit-results.json was created:"
          ls -la bandit-results.json || echo "File not created"

      - name: Upload Bandit Report to DefectDojo
        env:
          DD_URL: ${{ secrets.DEFECTDOJO_URL }}
          DD_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
          PRODUCT_NAME: ${{ secrets.PRODUCT_NAME }}
          ENGAGEMENT_BANDIT: ${{ secrets.ENGAGEMENT_BANDIT }}
        run: |
          curl -X POST "${DD_URL}/api/v2/import-scan/" \
            -H "Authorization: Token ${DD_TOKEN}" \
            -F "file=@bandit-results.json" \
            -F "scan_type=Bandit Scan" \
            -F "product_name=${PRODUCT_NAME}" \
            -F "engagement_name=${ENGAGEMENT_BANDIT}" \
            -F "active=true" \
            -F "minimum_severity=Low" \
            -F "lead=1" \
            -F "environment=Production"

      - name: Setup Snyk
        uses: snyk/actions/setup@master

      - name: Authenticate Snyk
        run: |
          echo "üîê Authenticating with Snyk..."
          snyk auth ${{ secrets.SNYK_TOKEN }}
          echo "Checking Snyk configuration:"
          snyk config get api
          snyk config get org || echo "No org configured"
          echo "Getting account info:"
          snyk whoami 2>&1 || echo "whoami failed"
          echo "‚úÖ Snyk authentication complete"

      - name: Run SNYK SCA - Requirements.txt
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          echo "üì¶ Running Snyk SCA scan on requirements.txt ONLY..."
          echo "Current directory: $(pwd)"

          echo "Checking requirements.txt:"
          wc -l app/requirements.txt
          head -10 app/requirements.txt
          tail -10 app/requirements.txt

          echo ""
          echo "Attempting multiple scan methods to find what works:"
          echo ""

          echo "Method 1: Scan with absolute path"
          snyk test --file=$(pwd)/app/requirements.txt --package-manager=pip --skip-unresolved --json > snyk-method1.json 2>&1 || true
          echo "Method 1 result: $(cat snyk-method1.json | python3 -c 'import json,sys; d=json.load(sys.stdin); print(f\"Deps: {d.get(\"dependencyCount\",0)}, Vulns: {len(d.get(\"vulnerabilities\",[]))}\")')"

          echo ""
          echo "Method 2: Scan from app directory with relative path"
          (cd app && snyk test --file=requirements.txt --package-manager=pip --skip-unresolved --json > ../snyk-method2.json 2>&1) || true
          echo "Method 2 result: $(cat snyk-method2.json | python3 -c 'import json,sys; d=json.load(sys.stdin); print(f\"Deps: {d.get(\"dependencyCount\",0)}, Vulns: {len(d.get(\"vulnerabilities\",[]))}\")')"

          echo ""
          echo "Method 3: Scan specifying target file"
          snyk test --file=app/requirements.txt --package-manager=pip --target-file=app/requirements.txt --skip-unresolved --json > snyk-method3.json 2>&1 || true
          echo "Method 3 result: $(cat snyk-method3.json | python3 -c 'import json,sys; d=json.load(sys.stdin); print(f\"Deps: {d.get(\"dependencyCount\",0)}, Vulns: {len(d.get(\"vulnerabilities\",[]))}\")')"

          echo ""
          echo "Comparing file sizes:"
          ls -lh snyk-method*.json

          echo ""
          echo "Using the method with most vulnerabilities:"
          BEST=$(ls -lS snyk-method*.json | head -1 | awk '{print $9}')
          cp $BEST snyk-requirements.json
          echo "Selected: $BEST"
          ls -lh snyk-requirements.json

          echo ""
          echo "Final scan statistics:"
          cat snyk-requirements.json | python3 -c "import json,sys; data=json.load(sys.stdin); print(f'Dependencies: {data.get(\"dependencyCount\", 0)}'); print(f'Vulnerabilities: {len(data.get(\"vulnerabilities\", []))}')" || echo "Failed to parse JSON"

      # - name: Run SNYK SCA - Poetry.lock
      #   continue-on-error: true
      #   env:
      #     SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      #   run: |
      #     echo "üì¶ Running Snyk SCA scan on poetry.lock..."
      #     cd app && snyk test --skip-unresolved --json > ../snyk-poetry.json || true
      #     cd ..
      #     echo "Poetry.lock scan complete:"
      #     ls -lh snyk-poetry.json
      #     echo "‚úÖ Both Snyk scans complete"

      - name: Upload Snyk Requirements.txt Report to DefectDojo
        if: always() && hashFiles('snyk-requirements.json') != ''
        env:
          DD_URL: ${{ secrets.DEFECTDOJO_URL }}
          DD_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
          PRODUCT_NAME: ${{ secrets.PRODUCT_NAME }}
          ENGAGEMENT_SNYK: ${{ secrets.ENGAGEMENT_SNYK }}
        run: |
          echo "üì§ Uploading Snyk requirements.txt scan to DefectDojo..."
          echo "File size: $(ls -lh snyk-requirements.json | awk '{print $5}')"

          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "${DD_URL}/api/v2/import-scan/" \
            -H "Authorization: Token ${DD_TOKEN}" \
            -F "file=@snyk-requirements.json" \
            -F "scan_type=Snyk Scan" \
            -F "product_name=${PRODUCT_NAME}" \
            -F "engagement_name=${ENGAGEMENT_SNYK}" \
            -F "active=true" \
            -F "minimum_severity=Low" \
            -F "lead=1" \
            -F "environment=Production")

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE:")

          echo "Upload status: $HTTP_CODE"
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            TEST_ID=$(echo "$BODY" | python3 -c "import json,sys; print(json.load(sys.stdin).get('test', 'N/A'))")
            STATS=$(echo "$BODY" | python3 -c "import json,sys; data=json.load(sys.stdin); stats=data.get('statistics',{}).get('after',{}).get('total',{}); print(f\"Imported: {stats.get('total',0)} findings\")")
            echo "‚úÖ Test ID: $TEST_ID"
            echo "‚úÖ $STATS"
          else
            echo "‚ùå Upload failed: $BODY"
          fi

      # - name: Upload Snyk Poetry.lock Report to DefectDojo
      #   if: always() && hashFiles('snyk-poetry.json') != ''
      #   env:
      #     DD_URL: ${{ secrets.DEFECTDOJO_URL }}
      #     DD_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
      #     PRODUCT_NAME: ${{ secrets.PRODUCT_NAME }}
      #     ENGAGEMENT_SNYK: ${{ secrets.ENGAGEMENT_SNYK }}
      #   run: |
      #     echo "üì§ Uploading Snyk poetry.lock scan to DefectDojo..."
      #     ls -lh snyk-poetry.json

      #     curl -X POST "${DD_URL}/api/v2/import-scan/" \
      #       -H "Authorization: Token ${DD_TOKEN}" \
      #       -F "file=@snyk-poetry.json" \
      #       -F "scan_type=Snyk Scan" \
      #       -F "product_name=${PRODUCT_NAME}" \
      #       -F "engagement_name=${ENGAGEMENT_SNYK}" \
      #       -F "active=true" \
      #       -F "minimum_severity=Low" \
      #       -F "lead=1" \
      #       -F "environment=Production"

      #     echo "‚úÖ Poetry.lock scan uploaded"

      - name: Upload Snyk Requirements Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-requirements-results
          path: snyk-requirements.json
          retention-days: 30

      # - name: Upload Snyk Poetry Artifact
      #   uses: actions/upload-artifact@v4
      #   if: always()
      #   with:
      #     name: snyk-poetry-results
      #     path: snyk-poetry.json
      #     retention-days: 30
