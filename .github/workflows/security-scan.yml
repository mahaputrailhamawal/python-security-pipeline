name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run every Monday at 9 AM
    - cron: '0 9 * * 1'

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit scan
        continue-on-error: true
        run: |
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          bandit -r app/ -f json -o bandit-results.json || true
          echo "âœ… Bandit scan complete"
          echo "Checking if bandit-results.json was created:"
          ls -la bandit-results.json || echo "File not created"

      - name: Upload Bandit Report to DefectDojo
        env:
          DD_URL: ${{ secrets.DEFECTDOJO_URL }}
          DD_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
          PRODUCT_NAME: ${{ secrets.PRODUCT_NAME }}
          ENGAGEMENT_BANDIT: ${{ secrets.ENGAGEMENT_BANDIT }}
        run: |
          curl -X POST "${DD_URL}/api/v2/import-scan/" \
            -H "Authorization: Token ${DD_TOKEN}" \
            -F "file=@bandit-results.json" \
            -F "scan_type=Bandit Scan" \
            -F "product_name=${PRODUCT_NAME}" \
            -F "engagement_name=${ENGAGEMENT_BANDIT}" \
            -F "active=true" \
            -F "minimum_severity=Low" \
            -F "lead=1" \
            -F "environment=Production"

      - name: Setup Snyk
        uses: snyk/actions/setup@master

      - name: Authenticate Snyk
        run: |
          echo "ðŸ” Authenticating with Snyk..."
          snyk auth ${{ secrets.SNYK_TOKEN }}
          snyk config get api
          echo "âœ… Snyk authentication complete"

      - name: Run SNYK SCA - Requirements.txt
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          echo "ðŸ“¦ Running Snyk SCA scan on requirements.txt..."
          echo "Current directory: $(pwd)"
          echo "Scanning requirements.txt (328 packages)..."
          cd app
          snyk test --file=requirements.txt --package-manager=pip --skip-unresolved --json > ../snyk-requirements.json || true
          cd ..
          echo "Requirements.txt scan complete:"
          ls -lh snyk-requirements.json
          cat snyk-requirements.json

      # - name: Run SNYK SCA - Poetry.lock
      #   continue-on-error: true
      #   env:
      #     SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      #   run: |
      #     echo "ðŸ“¦ Running Snyk SCA scan on poetry.lock..."
      #     cd app && snyk test --skip-unresolved --json > ../snyk-poetry.json || true
      #     cd ..
      #     echo "Poetry.lock scan complete:"
      #     ls -lh snyk-poetry.json
      #     echo "âœ… Both Snyk scans complete"

      - name: Upload Snyk Requirements.txt Report to DefectDojo
        if: always() && hashFiles('snyk-requirements.json') != ''
        env:
          DD_URL: ${{ secrets.DEFECTDOJO_URL }}
          DD_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
          PRODUCT_NAME: ${{ secrets.PRODUCT_NAME }}
          ENGAGEMENT_SNYK: ${{ secrets.ENGAGEMENT_SNYK }}
        run: |
          echo "ðŸ“¤ Uploading Snyk requirements.txt scan to DefectDojo..."
          ls -lh snyk-requirements.json
          cat snyk-requirements.json
          curl -X POST "${DD_URL}/api/v2/import-scan/" \
            -H "Authorization: Token ${DD_TOKEN}" \
            -F "file=@snyk-requirements.json" \
            -F "scan_type=Snyk Scan" \
            -F "product_name=${PRODUCT_NAME}" \
            -F "engagement_name=${ENGAGEMENT_SNYK}" \
            -F "active=true" \
            -F "minimum_severity=Low" \
            -F "lead=1" \
            -F "environment=Production"

          echo "âœ… Requirements.txt scan uploaded"

      # - name: Upload Snyk Poetry.lock Report to DefectDojo
      #   if: always() && hashFiles('snyk-poetry.json') != ''
      #   env:
      #     DD_URL: ${{ secrets.DEFECTDOJO_URL }}
      #     DD_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
      #     PRODUCT_NAME: ${{ secrets.PRODUCT_NAME }}
      #     ENGAGEMENT_SNYK: ${{ secrets.ENGAGEMENT_SNYK }}
      #   run: |
      #     echo "ðŸ“¤ Uploading Snyk poetry.lock scan to DefectDojo..."
      #     ls -lh snyk-poetry.json

      #     curl -X POST "${DD_URL}/api/v2/import-scan/" \
      #       -H "Authorization: Token ${DD_TOKEN}" \
      #       -F "file=@snyk-poetry.json" \
      #       -F "scan_type=Snyk Scan" \
      #       -F "product_name=${PRODUCT_NAME}" \
      #       -F "engagement_name=${ENGAGEMENT_SNYK}" \
      #       -F "active=true" \
      #       -F "minimum_severity=Low" \
      #       -F "lead=1" \
      #       -F "environment=Production"

      #     echo "âœ… Poetry.lock scan uploaded"

      - name: Upload Snyk Requirements Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-requirements-results
          path: snyk-requirements.json
          retention-days: 30

      # - name: Upload Snyk Poetry Artifact
      #   uses: actions/upload-artifact@v4
      #   if: always()
      #   with:
      #     name: snyk-poetry-results
      #     path: snyk-poetry.json
      #     retention-days: 30
