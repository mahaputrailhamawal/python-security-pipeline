name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run every Monday at 9 AM
    - cron: '0 9 * * 1'

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit scan
        continue-on-error: true
        run: |
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          bandit -r app/ -f json -o bandit-results.json || true
          echo "‚úÖ Bandit scan complete"
          echo "Checking if bandit-results.json was created:"
          ls -la bandit-results.json || echo "File not created"

      - name: Upload Bandit Report to DefectDojo
        env:
          DD_URL: ${{ secrets.DEFECTDOJO_URL }}
          DD_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
          PRODUCT_NAME: ${{ secrets.PRODUCT_NAME }}
          ENGAGEMENT_BANDIT: ${{ secrets.ENGAGEMENT_BANDIT }}
        run: |
          echo "üîç Step 1: Get Engagement ID..."
          ENGAGEMENT_RESPONSE=$(curl -s -X GET "${DD_URL}/api/v2/engagements/" \
            -H "Authorization: Token ${DD_TOKEN}" \
            -G --data-urlencode "name=${ENGAGEMENT_BANDIT}" \
            --data-urlencode "product__name=${PRODUCT_NAME}")

          ENGAGEMENT_ID=$(echo "$ENGAGEMENT_RESPONSE" | python3 -c "import json,sys; results=json.load(sys.stdin).get('results',[]); print(results[0]['id'] if results else '')" 2>/dev/null || echo "")

          if [ -z "$ENGAGEMENT_ID" ]; then
            echo "‚ùå Engagement not found: ${ENGAGEMENT_BANDIT}"
            exit 1
          fi

          echo "‚úÖ Found Engagement ID: ${ENGAGEMENT_ID}"

          echo ""
          echo "üîç Step 2: Check for existing Bandit test..."
          TESTS_RESPONSE=$(curl -s -X GET "${DD_URL}/api/v2/tests/" \
            -H "Authorization: Token ${DD_TOKEN}" \
            -G --data-urlencode "engagement=${ENGAGEMENT_ID}" \
            --data-urlencode "scan_type=Bandit Scan")

          TEST_ID=$(echo "$TESTS_RESPONSE" | python3 -c "import json,sys; results=json.load(sys.stdin).get('results',[]); sorted_results=sorted(results, key=lambda x: x.get('id',0), reverse=True); print(sorted_results[0]['id'] if sorted_results else '')" 2>/dev/null || echo "")

          echo ""
          if [ -z "$TEST_ID" ]; then
            echo "üìù Step 3a: No existing test found - Creating NEW test with import-scan..."
            RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "${DD_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DD_TOKEN}" \
              -F "file=@bandit-results.json" \
              -F "scan_type=Bandit Scan" \
              -F "product_name=${PRODUCT_NAME}" \
              -F "engagement_name=${ENGAGEMENT_BANDIT}" \
              -F "active=true" \
              -F "verified=false" \
              -F "minimum_severity=Low" \
              -F "close_old_findings=false" \
              -F "push_to_jira=false" \
              -F "lead=1" \
              -F "environment=Production")

            HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
            BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE:")

            if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
              NEW_TEST_ID=$(echo "$BODY" | python3 -c "import json,sys; print(json.load(sys.stdin).get('test', 'N/A'))")
              STATS=$(echo "$BODY" | python3 -c "import json,sys; data=json.load(sys.stdin); stats=data.get('statistics',{}).get('after',{}).get('total',{}); print(f\"Total: {stats.get('total',0)}, Critical: {stats.get('critical',0)}, High: {stats.get('high',0)}, Medium: {stats.get('medium',0)}, Low: {stats.get('low',0)}\")")
              echo "‚úÖ Created NEW Test ID: ${NEW_TEST_ID}"
              echo "‚úÖ Findings: ${STATS}"
            else
              echo "‚ùå Import failed (HTTP ${HTTP_CODE}): ${BODY}"
              exit 1
            fi
          else
            echo "üîÑ Step 3b: Found existing Test ID ${TEST_ID} - Using REIMPORT to avoid duplicates..."
            RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "${DD_URL}/api/v2/reimport-scan/" \
              -H "Authorization: Token ${DD_TOKEN}" \
              -F "file=@bandit-results.json" \
              -F "scan_type=Bandit Scan" \
              -F "test=${TEST_ID}" \
              -F "active=true" \
              -F "verified=false" \
              -F "minimum_severity=Low" \
              -F "close_old_findings=true" \
              -F "push_to_jira=false")

            HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
            BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE:")

            if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
              STATS_AFTER=$(echo "$BODY" | python3 -c "import json,sys; data=json.load(sys.stdin); stats=data.get('statistics',{}).get('after',{}).get('total',{}); print(f\"Total: {stats.get('total',0)}, Critical: {stats.get('critical',0)}, High: {stats.get('high',0)}, Medium: {stats.get('medium',0)}, Low: {stats.get('low',0)}\")")
              STATS_DELTA=$(echo "$BODY" | python3 -c "import json,sys; data=json.load(sys.stdin); delta=data.get('statistics',{}).get('delta',{}).get('total',{}); print(f\"Œî Total: {delta.get('total',0):+d}, Œî Critical: {delta.get('critical',0):+d}, Œî High: {delta.get('high',0):+d}, Œî Medium: {delta.get('medium',0):+d}, Œî Low: {delta.get('low',0):+d}\")")
              echo "‚úÖ Reimported to Test ID: ${TEST_ID}"
              echo "‚úÖ Current Findings: ${STATS_AFTER}"
              echo "‚úÖ Changes: ${STATS_DELTA} (+ = new findings, - = closed/fixed)"
            else
              echo "‚ùå Reimport failed (HTTP ${HTTP_CODE}): ${BODY}"
              exit 1
            fi
          fi

      - name: Setup Snyk
        uses: snyk/actions/setup@master

      - name: Authenticate Snyk
        run: |
          echo "üîê Authenticating with Snyk..."
          snyk auth ${{ secrets.SNYK_TOKEN }}
          echo "‚úÖ Snyk authentication complete"

      - name: Install Python Dependencies
        run: |
          echo "üì¶ Installing dependencies from requirements.txt..."
          pip install -r app/requirements.txt
          echo "‚úÖ Dependencies installed"

      - name: Run SNYK SCA - Requirements.txt
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          echo "üì¶ Running Snyk SCA scan on requirements.txt..."
          echo "Current directory: $(pwd)"
          echo ""
          echo "Running Snyk scan..."
          cd app && snyk test --file=requirements.txt --package-manager=pip --skip-unresolved --json > ../snyk-results.json 2>&1 || true
          cd ..
          echo "Parsing JSON:"
          cat snyk-results.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(f'‚úÖ Dependencies: {d.get(\"dependencyCount\",0)}'); print(f'‚úÖ Vulnerabilities: {len(d.get(\"vulnerabilities\",[]))}'); print(f'‚úÖ Package Manager: {d.get(\"packageManager\",\"N/A\")}')"
          echo "‚úÖ Snyk scan complete"

      - name: Upload Snyk Requirements.txt Report to DefectDojo
        if: always() && hashFiles('snyk-results.json') != ''
        env:
          DD_URL: ${{ secrets.DEFECTDOJO_URL }}
          DD_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
          PRODUCT_NAME: ${{ secrets.PRODUCT_NAME }}
          ENGAGEMENT_SNYK: ${{ secrets.ENGAGEMENT_SNYK }}
        run: |
          echo "üì§ Uploading Snyk scan to DefectDojo..."
          echo "File size: $(ls -lh snyk-results.json | awk '{print $5}')"
          echo ""

          echo "üîç Step 1: Get Engagement ID..."
          ENGAGEMENT_RESPONSE=$(curl -s -X GET "${DD_URL}/api/v2/engagements/" \
            -H "Authorization: Token ${DD_TOKEN}" \
            -G --data-urlencode "name=${ENGAGEMENT_SNYK}" \
            --data-urlencode "product__name=${PRODUCT_NAME}")

          ENGAGEMENT_ID=$(echo "$ENGAGEMENT_RESPONSE" | python3 -c "import json,sys; results=json.load(sys.stdin).get('results',[]); print(results[0]['id'] if results else '')" 2>/dev/null || echo "")

          if [ -z "$ENGAGEMENT_ID" ]; then
            echo "‚ùå Engagement not found: ${ENGAGEMENT_SNYK}"
            exit 1
          fi

          echo "‚úÖ Found Engagement ID: ${ENGAGEMENT_ID}"

          echo ""
          echo "üîç Step 2: Check for existing Snyk test..."
          TESTS_RESPONSE=$(curl -s -X GET "${DD_URL}/api/v2/tests/" \
            -H "Authorization: Token ${DD_TOKEN}" \
            -G --data-urlencode "engagement=${ENGAGEMENT_ID}" \
            --data-urlencode "scan_type=Snyk Scan")

          TEST_ID=$(echo "$TESTS_RESPONSE" | python3 -c "import json,sys; results=json.load(sys.stdin).get('results',[]); sorted_results=sorted(results, key=lambda x: x.get('id',0), reverse=True); print(sorted_results[0]['id'] if sorted_results else '')" 2>/dev/null || echo "")

          echo ""
          if [ -z "$TEST_ID" ]; then
            echo "üìù Step 3a: No existing test found - Creating NEW test with import-scan..."
            RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "${DD_URL}/api/v2/import-scan/" \
              -H "Authorization: Token ${DD_TOKEN}" \
              -F "file=@snyk-results.json" \
              -F "scan_type=Snyk Scan" \
              -F "product_name=${PRODUCT_NAME}" \
              -F "engagement_name=${ENGAGEMENT_SNYK}" \
              -F "active=true" \
              -F "verified=false" \
              -F "minimum_severity=Low" \
              -F "close_old_findings=false" \
              -F "push_to_jira=false" \
              -F "lead=1" \
              -F "environment=Production")

            HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
            BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE:")

            if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
              NEW_TEST_ID=$(echo "$BODY" | python3 -c "import json,sys; print(json.load(sys.stdin).get('test', 'N/A'))")
              STATS=$(echo "$BODY" | python3 -c "import json,sys; data=json.load(sys.stdin); stats=data.get('statistics',{}).get('after',{}).get('total',{}); print(f\"Total: {stats.get('total',0)}, Critical: {stats.get('critical',0)}, High: {stats.get('high',0)}, Medium: {stats.get('medium',0)}, Low: {stats.get('low',0)}\")")
              echo "‚úÖ Created NEW Test ID: ${NEW_TEST_ID}"
              echo "‚úÖ Findings: ${STATS}"
            else
              echo "‚ùå Import failed (HTTP ${HTTP_CODE}): ${BODY}"
              exit 1
            fi
          else
            echo "üîÑ Step 3b: Found existing Test ID ${TEST_ID} - Using REIMPORT to avoid duplicates..."
            RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "${DD_URL}/api/v2/reimport-scan/" \
              -H "Authorization: Token ${DD_TOKEN}" \
              -F "file=@snyk-results.json" \
              -F "scan_type=Snyk Scan" \
              -F "test=${TEST_ID}" \
              -F "active=true" \
              -F "verified=false" \
              -F "minimum_severity=Low" \
              -F "close_old_findings=true" \
              -F "push_to_jira=false")

            HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
            BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE:")

            if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
              STATS_AFTER=$(echo "$BODY" | python3 -c "import json,sys; data=json.load(sys.stdin); stats=data.get('statistics',{}).get('after',{}).get('total',{}); print(f\"Total: {stats.get('total',0)}, Critical: {stats.get('critical',0)}, High: {stats.get('high',0)}, Medium: {stats.get('medium',0)}, Low: {stats.get('low',0)}\")")
              STATS_DELTA=$(echo "$BODY" | python3 -c "import json,sys; data=json.load(sys.stdin); delta=data.get('statistics',{}).get('delta',{}).get('total',{}); print(f\"Œî Total: {delta.get('total',0):+d}, Œî Critical: {delta.get('critical',0):+d}, Œî High: {delta.get('high',0):+d}, Œî Medium: {delta.get('medium',0):+d}, Œî Low: {delta.get('low',0):+d}\")")
              echo "‚úÖ Reimported to Test ID: ${TEST_ID}"
              echo "‚úÖ Current Findings: ${STATS_AFTER}"
              echo "‚úÖ Changes: ${STATS_DELTA} (+ = new findings, - = closed/fixed)"
            else
              echo "‚ùå Reimport failed (HTTP ${HTTP_CODE}): ${BODY}"
              exit 1
            fi
          fi

      - name: Upload Snyk Requirements Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-requirements-results
          path: snyk-results.json
          retention-days: 30