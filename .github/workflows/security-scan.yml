name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run every Monday at 9 AM
    - cron: '0 9 * * 1'

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit scan
        continue-on-error: true
        run: |
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          bandit -r app/ -f json -o bandit-results.json || true
          echo "‚úÖ Bandit scan complete"
          echo "Checking if bandit-results.json was created:"
          ls -la bandit-results.json || echo "File not created"

      - name: Upload Bandit Report to DefectDojo
        env:
          DD_URL: ${{ secrets.DEFECTDOJO_URL }}
          DD_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
          PRODUCT_NAME: ${{ secrets.PRODUCT_NAME }}
          ENGAGEMENT_BANDIT: ${{ secrets.ENGAGEMENT_BANDIT }}
        run: |
          curl -X POST "${DD_URL}/api/v2/import-scan/" \
            -H "Authorization: Token ${DD_TOKEN}" \
            -F "file=@bandit-results.json" \
            -F "scan_type=Bandit Scan" \
            -F "product_name=${PRODUCT_NAME}" \
            -F "engagement_name=${ENGAGEMENT_BANDIT}" \
            -F "active=true" \
            -F "minimum_severity=Low" \
            -F "lead=1" \
            -F "environment=Production"

      - name: Setup Snyk
        uses: snyk/actions/setup@master

      - name: Authenticate Snyk
        run: |
          echo "üîê Authenticating with Snyk..."
          snyk auth ${{ secrets.SNYK_TOKEN }}
          echo "‚úÖ Snyk authentication complete"

      - name: Install Python Dependencies
        run: |
          echo "üì¶ Installing dependencies from requirements.txt..."
          pip install -r app/requirements.txt
          echo "‚úÖ Dependencies installed"

      - name: Run SNYK SCA - Requirements.txt
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          echo "üì¶ Running Snyk SCA scan on requirements.txt..."
          echo "Current directory: $(pwd)"
          echo ""
          echo "Running Snyk scan..."
          cd app && snyk test --file=requirements.txt --package-manager=pip --skip-unresolved --json > ../snyk-results.json 2>&1 || true
          cd ..
          echo "Parsing JSON:"
          cat snyk-results.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(f'‚úÖ Dependencies: {d.get(\"dependencyCount\",0)}'); print(f'‚úÖ Vulnerabilities: {len(d.get(\"vulnerabilities\",[]))}'); print(f'‚úÖ Package Manager: {d.get(\"packageManager\",\"N/A\")}')"
          echo "‚úÖ Snyk scan complete"

      - name: Upload Snyk Requirements.txt Report to DefectDojo
        if: always() && hashFiles('snyk-results.json') != ''
        env:
          DD_URL: ${{ secrets.DEFECTDOJO_URL }}
          DD_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
          PRODUCT_NAME: ${{ secrets.PRODUCT_NAME }}
          ENGAGEMENT_SNYK: ${{ secrets.ENGAGEMENT_SNYK }}
        run: |
          echo "üì§ Uploading Snyk requirements.txt scan to DefectDojo..."
          echo "File size: $(ls -lh snyk-results.json | awk '{print $5}')"

          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "${DD_URL}/api/v2/import-scan/" \
            -H "Authorization: Token ${DD_TOKEN}" \
            -F "file=@snyk-results.json" \
            -F "scan_type=Snyk Scan" \
            -F "product_name=${PRODUCT_NAME}" \
            -F "engagement_name=${ENGAGEMENT_SNYK}" \
            -F "active=true" \
            -F "minimum_severity=Low" \
            -F "lead=1" \
            -F "environment=Production")

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE:")

          echo "Upload status: $HTTP_CODE"
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            TEST_ID=$(echo "$BODY" | python3 -c "import json,sys; print(json.load(sys.stdin).get('test', 'N/A'))")
            STATS=$(echo "$BODY" | python3 -c "import json,sys; data=json.load(sys.stdin); stats=data.get('statistics',{}).get('after',{}).get('total',{}); print(f\"Imported: {stats.get('total',0)} findings\")")
            echo "‚úÖ Test ID: $TEST_ID"
            echo "‚úÖ $STATS"
          else
            echo "‚ùå Upload failed: $BODY"
          fi

      - name: Upload Snyk Requirements Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-requirements-results
          path: snyk-results.json
          retention-days: 30