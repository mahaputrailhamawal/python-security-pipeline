name: Snyk Debug

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Setup Snyk
        uses: snyk/actions/setup@master

      - name: Snyk Version and Config
        run: |
          echo "=== Snyk CLI Version ==="
          snyk version

          echo ""
          echo "=== Snyk Config ==="
          snyk config

      - name: Authenticate Snyk
        run: |
          echo "ðŸ” Authenticating..."
          snyk auth ${{ secrets.SNYK_TOKEN }}
          snyk whoami

      - name: Environment Check
        run: |
          echo "=== Working Directory ==="
          pwd

          echo ""
          echo "=== App Directory Contents ==="
          ls -lah app/

          echo ""
          echo "=== Requirements.txt (first 20 lines) ==="
          head -20 app/requirements.txt

          echo ""
          echo "=== Requirements.txt line count ==="
          wc -l app/requirements.txt

      - name: Test Method 1 - From root with file path
        run: |
          echo "=== Method 1: snyk test --file=app/requirements.txt ==="
          snyk test --file=app/requirements.txt --package-manager=pip --skip-unresolved --json > method1.json 2>&1 || true
          echo "File size: $(ls -lh method1.json | awk '{print $5}')"
          cat method1.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(f'Deps: {d.get(\"dependencyCount\",0)}, Vulns: {len(d.get(\"vulnerabilities\",[]))}'); print(f'Package Manager: {d.get(\"packageManager\",\"N/A\")}')"

      - name: Test Method 2 - CD into app directory
        run: |
          echo "=== Method 2: cd app && snyk test --file=requirements.txt ==="
          cd app && snyk test --file=requirements.txt --package-manager=pip --skip-unresolved --json > ../method2.json 2>&1 || true
          cd ..
          echo "File size: $(ls -lh method2.json | awk '{print $5}')"
          cat method2.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(f'Deps: {d.get(\"dependencyCount\",0)}, Vulns: {len(d.get(\"vulnerabilities\",[]))}'); print(f'Package Manager: {d.get(\"packageManager\",\"N/A\")}')"

      - name: Test Method 3 - Explicit pip with no poetry detection
        run: |
          echo "=== Method 3: Hide poetry files first ==="
          mv app/poetry.lock app/poetry.lock.tmp 2>/dev/null || true
          mv app/pyproject.toml app/pyproject.toml.tmp 2>/dev/null || true

          cd app && snyk test --file=requirements.txt --package-manager=pip --skip-unresolved --json > ../method3.json 2>&1 || true
          cd ..

          mv app/poetry.lock.tmp app/poetry.lock 2>/dev/null || true
          mv app/pyproject.toml.tmp app/pyproject.toml 2>/dev/null || true

          echo "File size: $(ls -lh method3.json | awk '{print $5}')"
          cat method3.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(f'Deps: {d.get(\"dependencyCount\",0)}, Vulns: {len(d.get(\"vulnerabilities\",[]))}'); print(f'Package Manager: {d.get(\"packageManager\",\"N/A\")}')"

      - name: Compare Results
        run: |
          echo "=== Comparison ==="
          echo "Method 1: $(ls -lh method1.json | awk '{print $5}')"
          echo "Method 2: $(ls -lh method2.json | awk '{print $5}')"
          echo "Method 3: $(ls -lh method3.json | awk '{print $5}')"

          echo ""
          echo "=== Best Method (largest file) ==="
          ls -lSh method*.json | head -1

      - name: Upload Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-debug-results
          path: method*.json
